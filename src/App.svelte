<script>
	import "fluent-svelte/theme.css";
	import {
		TextBox,
		Button,
		ContentDialog,
		ProgressRing,
		TextBlock,
	} from "fluent-svelte";
	let loaderIsOpen = false;
	import Card from "./components/Card.svelte";
	let searchbar;
	let err1IsOpen = false;
	let err2IsOpen = false;
	function search() {
		if (searchbar !== "") {
			loaderIsOpen = true;
			fetch(
				`https://services.nvd.nist.gov/rest/json/cve/1.0/${searchbar}`
			)
				.then((response) => response.json())
				.then((data) => {
					loaderIsOpen = false;
					console.log(data);
					for (let i = 0; i < data.result.CVE_Items.length; i++) {
						console.log(data.result.CVE_data_timestamp);
						let card = new Card({
							target: document.getElementById("cards"),
							props: {
								severity:
									data.result.CVE_Items[i].impact.baseMetricV2
										.severity,
								vulnerabilityid:
									data.result.CVE_Items[i].cve.CVE_data_meta
										.ID,
								assigner:
									data.result.CVE_Items[i].cve.CVE_data_meta
										.ASSIGNER,
								date: `${data.result.CVE_data_timestamp.slice(
									0,
									10
								)}`,
								description:
									data.result.CVE_Items[0].cve.description
										.description_data[0].value,
							},
						});
					}
				})
				.catch((error) => {
					err2IsOpen = true;
				});
		} else {
			err1IsOpen = true;
		}
	}
</script>

<div id="search-bar">
	<TextBox
		bind:value={searchbar}
		placeholder="Search"
		type="search"
		on:search={search}
	/>
</div>

<div id="root">
	<div id="cards" />
</div>
<ContentDialog bind:open={loaderIsOpen}>
	<TextBlock variant="body">Please Wait...</TextBlock>
	<ProgressRing size={16} />
</ContentDialog>
<ContentDialog bind:open={err1IsOpen} title="Error">
	Please Enter A CVE ID
	<Button slot="footer" on:click={() => (err1IsOpen = false)}>Close</Button>
</ContentDialog>
<ContentDialog bind:open={err2IsOpen} title="Error">
	The ID you entered is invalid or the connection to the server cannot be
	established. Please enter a valid ID or check your internet
	<Button slot="footer" on:click={() => (err2IsOpen = false)}>Close</Button>
</ContentDialog>

<style>
	#search-bar {
		position: absolute;
		width: 50%;
		height: auto;
		left: 50%;
		top: 16px;
		transform: translate(-50%, 0%);
	}
	#root {
		position: absolute;
		width: 100%;
		margin-top: 64px;
		height: calc(100% - 64px);
		height: auto;
	}
	#cards {
		display: flex;
		width: 75%;
		height: 100%;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		margin-left: 12.5%;
		gap: 16px;
	}
	:global(body) {
		background-color: var(--fds-solid-background-base);
		color: var(--fds-text-primary);
	}
</style>
